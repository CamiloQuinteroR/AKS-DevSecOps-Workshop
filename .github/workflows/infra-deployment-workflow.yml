on:
  push:
    branches:
      - main
    paths:
      - 'tools/deploy/module0/**'

  workflow_dispatch:

env:
  CLUSTER_RESOURCE_GROUP: ${{ secrets.CLUSTER_RESOURCE_GROUP }}

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Log into Azure
      - name: Azure login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Register required Azure providers (MUY IMPORTANTE)
      - name: Register Azure providers
        run: |
          az provider register --namespace Microsoft.ContainerService
          az provider register --namespace Microsoft.ContainerRegistry
          az provider register --namespace Microsoft.Compute
          az provider register --namespace Microsoft.Network

          echo "Waiting for provider registration..."
          sleep 90

      # Deploy Bicep file
      - name: Deploy AKS
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ secrets.CLUSTER_RESOURCE_GROUP }}
          template: tools/deploy/module0/aks.bicep
          deploymentName: aks-${{ github.run_id }}
          failOnStdErr: false

      # Attach ACR to AKS
      - name: Attach Azure Container Registry to AKS
        run: |
          CLUSTER_NAME=$(az aks list --resource-group ${{ secrets.CLUSTER_RESOURCE_GROUP }} --query "[].name" -o tsv)
          ACR_NAME=$(az acr list --resource-group ${{ secrets.CLUSTER_RESOURCE_GROUP }} --query "[].name" -o tsv)

          az aks update -n $CLUSTER_NAME -g ${{ secrets.CLUSTER_RESOURCE_GROUP }} --attach-acr $ACR_NAME